# 小程序端集成示例

## 1. 在 app.js 中添加全局配置

```javascript
// app.js
App({
  globalData: {
    apiBase: 'http://your-api-domain.com', // 生产环境改为实际域名
    openid: null
  },

  onLaunch() {
    // 应用启动时尝试登录
    this.login();
  },

  // 登录方法
  login() {
    return new Promise((resolve, reject) => {
      // 先检查本地是否已有 openid
      const storedOpenId = wx.getStorageSync('openid');
      if (storedOpenId) {
        this.globalData.openid = storedOpenId;
        resolve(storedOpenId);
        return;
      }

      // 获取微信登录 code
      wx.login({
        success: (res) => {
          if (res.code) {
            // 发送 code 到后端换取 openid
            wx.request({
              url: `${this.globalData.apiBase}/login`,
              method: 'POST',
              data: {
                code: res.code
              },
              success: (result) => {
                if (result.statusCode === 200) {
                  const openid = result.data.openid;
                  // 保存到本地和全局
                  wx.setStorageSync('openid', openid);
                  this.globalData.openid = openid;
                  console.log('登录成功，openid:', openid);
                  resolve(openid);
                } else {
                  console.error('登录失败:', result);
                  reject(result);
                }
              },
              fail: (error) => {
                console.error('登录请求失败:', error);
                reject(error);
              }
            });
          } else {
            console.error('获取 code 失败:', res.errMsg);
            reject(res);
          }
        },
        fail: (error) => {
          console.error('wx.login 失败:', error);
          reject(error);
        }
      });
    });
  }
});
```

## 2. 创建请求工具类

```javascript
// utils/request.js
const app = getApp();

/**
 * 封装的请求方法
 * @param {string} url - 请求路径（相对路径，如 '/items'）
 * @param {object} options - 请求选项
 * @returns {Promise}
 */
function request(url, options = {}) {
  return new Promise((resolve, reject) => {
    // 确保有 openid
    const openid = app.globalData.openid || wx.getStorageSync('openid');
    
    if (!openid && !url.endsWith('/login')) {
      // 如果没有 openid 且不是登录请求，先登录
      app.login().then(() => {
        // 登录成功后重新发起请求
        request(url, options).then(resolve).catch(reject);
      }).catch(reject);
      return;
    }

    // 构建完整的请求配置
    const requestConfig = {
      url: `${app.globalData.apiBase}${url}`,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'content-type': 'application/json',
        'X-OpenId': openid, // 在 header 中携带 openid
        ...options.header
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data);
        } else if (res.statusCode === 401) {
          // 认证失败，清除本地 openid 并重新登录
          wx.removeStorageSync('openid');
          app.globalData.openid = null;
          wx.showToast({
            title: '登录已过期，请重新登录',
            icon: 'none'
          });
          reject(res);
        } else {
          wx.showToast({
            title: res.data.detail || '请求失败',
            icon: 'none'
          });
          reject(res);
        }
      },
      fail: (error) => {
        wx.showToast({
          title: '网络请求失败',
          icon: 'none'
        });
        reject(error);
      }
    };

    wx.request(requestConfig);
  });
}

module.exports = {
  request,
  // 快捷方法
  get: (url, data) => request(url, { method: 'GET', data }),
  post: (url, data) => request(url, { method: 'POST', data }),
  put: (url, data) => request(url, { method: 'PUT', data }),
  patch: (url, data) => request(url, { method: 'PATCH', data })
};
```

## 3. 在页面中使用

```javascript
// pages/index/index.js
const api = require('../../utils/request.js');

Page({
  data: {
    items: []
  },

  onLoad() {
    this.loadItems();
  },

  // 加载物品列表
  async loadItems() {
    wx.showLoading({ title: '加载中...' });
    try {
      const result = await api.get('/items');
      this.setData({
        items: result.items
      });
    } catch (error) {
      console.error('加载物品列表失败:', error);
    } finally {
      wx.hideLoading();
    }
  },

  // 添加物品
  async addItem() {
    try {
      const result = await api.post('/items', {
        name: '苹果',
        expire_date: '2025-12-31',
        quantity: 5
      });
      wx.showToast({
        title: '添加成功',
        icon: 'success'
      });
      this.loadItems(); // 刷新列表
    } catch (error) {
      console.error('添加物品失败:', error);
    }
  },

  // 更新物品
  async updateItem(itemId) {
    try {
      await api.patch(`/items/${itemId}`, {
        quantity: 10
      });
      wx.showToast({
        title: '更新成功',
        icon: 'success'
      });
      this.loadItems();
    } catch (error) {
      console.error('更新物品失败:', error);
    }
  },

  // 删除物品
  async deleteItem(itemId) {
    try {
      await api.patch(`/items/${itemId}/delete`);
      wx.showToast({
        title: '删除成功',
        icon: 'success'
      });
      this.loadItems();
    } catch (error) {
      console.error('删除物品失败:', error);
    }
  }
});
```

## 4. 团队相关操作示例

```javascript
// 创建团队
async createTeam(teamName) {
  try {
    const result = await api.post('/teams', {
      name: teamName
    });
    console.log('团队创建成功:', result);
    return result;
  } catch (error) {
    console.error('创建团队失败:', error);
  }
}

// 加入团队
async joinTeam(inviteCode) {
  try {
    const result = await api.post('/teams/join', {
      inviteCode: inviteCode
    });
    wx.showToast({
      title: '加入团队成功',
      icon: 'success'
    });
    return result;
  } catch (error) {
    console.error('加入团队失败:', error);
  }
}

// 获取团队列表
async getTeams() {
  try {
    const result = await api.get('/teams');
    return result.teams;
  } catch (error) {
    console.error('获取团队列表失败:', error);
  }
}

// 获取团队物品
async getTeamItems(teamId) {
  try {
    const result = await api.get(`/items?teamId=${teamId}`);
    return result.items;
  } catch (error) {
    console.error('获取团队物品失败:', error);
  }
}
```

## 5. 用户信息相关

```javascript
// 获取用户信息
async getUserInfo() {
  try {
    const result = await api.get('/me');
    console.log('用户信息:', result);
    return result;
  } catch (error) {
    console.error('获取用户信息失败:', error);
  }
}

// 更新用户信息
async updateUserInfo(data) {
  try {
    const result = await api.patch('/me', {
      nickname: data.nickname,
      phoneNumber: data.phoneNumber,
      avatarUrl: data.avatarUrl,
      reminderDays: data.reminderDays
    });
    wx.showToast({
      title: '更新成功',
      icon: 'success'
    });
    return result;
  } catch (error) {
    console.error('更新用户信息失败:', error);
  }
}
```

## 注意事项

1. **API 域名配置**：在小程序管理后台配置服务器域名（request 合法域名）
2. **生产环境**：修改 `app.globalData.apiBase` 为实际的生产域名
3. **HTTPS**：生产环境必须使用 HTTPS
4. **错误处理**：根据实际需求完善错误处理逻辑
5. **调试**：开发阶段可以在"开发者工具 - 详情 - 本地设置"中勾选"不校验合法域名"

## 测试

在开发者工具中可以使用以下方式测试：

1. 启动后端服务（确保在 8000 端口运行）
2. 将 `apiBase` 改为 `http://localhost:8000` 或 `http://your-local-ip:8000`
3. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
4. 运行小程序并查看控制台输出

